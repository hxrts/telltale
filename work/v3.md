# Work Plan: Effects/ + Proof-Carrying Runtime + Composable Deployment

**Documentation:** Maintain `lean/Effects/CODE_MAP.md` throughout this work (see Documentation Protocol)

---

## Overview

**Goal**: Type-safe protocol composition with formal guarantees:
- Composition is type-safe
- Untrusted actors cannot violate protocol invariants
- Composition provably maintains deadlock freedom

**Structure**:
- Part 1 (Phases 1-7): Effects/ codebase (self-contained)
- Part 2 (Phases 8-12): RumpsteakV2 integration
- Part 3 (Phases 13-14): Composition guarantees

---

## Summary

| Phase | File | Axioms | Status |
|-------|------|--------|--------|
| 1 | Environments.lean    | 0 | Complete |
| 2 | Coherence.lean       | 0  | 4/4 main theorems proven (axioms discharged) |
| 3 | Preservation.lean    | 0  | Frame lemmas proved under disjointness |
| 4 | Preservation.lean    | –  | Complete (TypedStep wrappers) |
| 4B | Typing.lean         | 0  | ParSplit/extensionality axioms discharged |
| 5 | Semantics.lean       | 0  | Complete |
| 6 | Monitor.lean         | 0  | Complete |
| 7 | DeadlockFreedom.lean | 0  | deadlock_free proved w/ ProgressReady gap |
| 7.5 | Spatial.lean       | 0  | Complete |
| 7.6 | Determinism.lean   | 0  | Complete |
| 7.7 | Deployment.lean    | 0  | MergeDEnv axioms discharged |
| - | Simulation.lean      | 0  | Complete |
| - | Examples.lean        | 0  | Complete |

**Total: 0 axioms, 0 sorries across Effects/**

**Current status:** All sorries eliminated. SEnv/DEnv are extensional (function-backed) and ParSplit is proof-irrelevant; typing extensionality axioms discharged. Core typing/preservation builds. Monitor fully proven (0 axioms). Coherence endpoint-completeness axiom removed by strengthening `EdgeCoherent` (now yields sender existence). `initSession_coherent` remains proven (with placeholder projection assumption). Deployment merge axioms are discharged. DeadlockFreedom is now proven under a ProgressReady assumption to be discharged by projection.

---

## Lean4/Mathlib4 Notes (DeepWiki)

**Lean4 core tactics**: `simp`, `grind`, `bv_decide` are available out of the box for routine rewriting and decision procedures. These should be the default automation pass before custom proofs.  
**Mathlib4 tactics**: `Mathlib.Tactic` aggregates standard automation such as `simp`, `norm_num`, `ring`, `linarith`, `omega`, plus domain-specific tactics (e.g., `continuity`, `measurability`, `positivity`, `polyrith`).  
**Practical guidance**:
- Start with `simp` using local simp-lemmas for function-backed envs; fall back to small helper lemmas if standard library lemmas aren’t enough.
- Use `linarith`/`omega` only for numeric side-goals introduced by measure/length indices.
- Prefer `grind` for “obvious” propositional closure goals (case splits over map lookups).

---

## Proof Strategy Addendum

This section records historical axiom clusters (all completed).

### Phase 1: Environments.lean — extensional env plumbing (complete)

**Goal**: Replace axioms with small lookup/update lemmas over function-backed `DEnv`/`SEnv`.

**Plan**:
1. Locate the concrete definitions of `DEnv`, `SEnv`, `Buffers`, and `lookup*` helpers (in `lean/Effects/Environments/*`).
2. For each axiom, rephrase it as an extensional `lookup` property with a key equality split.
3. Add local lemmas in `Environments/Part1` and `Part2` that bridge `lookup*`/`find?`, then use `simp` and `by_cases h : k = k'`.
4. If lemma coverage is missing, prove minimal wrappers (keep them local to `Environments`).

**Expected tools**: `simp`, `cases`, `by_cases`, `ext`, `simp [lookupSEnv, updateSEnv, SEnvUnion, lookupD, updateD]`.

### Phase 4B: Typing.lean — environment and disjointness lemmas (complete)

**Goal**: Completed; retained as historical notes for proof structure.

**Plan**:
1. **Part1 (ParSplit/SEnv append/disjointness)**: Prove associativity and subset lemmas by unfolding `SEnv.append` (now function-based) and applying extensionality + lookup lemmas.
2. **Part3a (lookup/append/domain)**: Show append is left-biased/right-biased as required; derive `SEnvDomSubset_*` from `lookupSEnv_*` by extensionality on keys.
3. **Part4/Part5 (HasTypeProcPre frames)**: Reuse existing framing proofs from `work/effects/008.lean` and adapt to function-backed SEnv (replace list-based lemmas with extensional lookups).
4. **Part6 (preservation sub-lemmas)**: Inline the already-proved `*_preserved` lemmas in `Coherence/Part8.lean` and strip axioms by direct rewriting.
5. **Part7 (append empty)**: Prove by extensionality on `lookup` with Phase 1 lemmas.

**Expected tools**: `simp`/`simp?`, `ext`, `cases` on `DecidableEq`, `grind` for propositional closure.

### Phase 3: Preservation.lean helpers (0 axioms)

**Goal**: Frame lemmas for Step wrt append.

**Plan**:
1. [x] `Step_frame_append_*` proven (requires disjointness + DConsistent to avoid DEnv overlap).

### Phase 7: DeadlockFreedom.lean (0 axioms; 1 gap)

**Goal**: Replace the remaining axiom and isolate the missing progress gap.

**Plan**:
1. [x] `subst_preserves_muDepth`: induction on type structure; simp on substitution.
2. [x] `reachesComm_body_implies_unfold_aux`: isolate the “unfold once” lemma for `μ`, then use reachability closure.
3. [x] `deadlock_free`: proven using `progress` plus a ProgressReady assumption (gap for projection).

### Phase 7.7: Deployment.lean — complete

**Goal**: Discharge `MergeDEnv_Left/Right` with DEnv append lemmas.

**Result**: `MergeDEnv_Left/Right` proven via `lookupD_append_left/right` (no axioms remain).

---
---

## Key Theorems Summary

| # | Theorem | Phase | Status |
|---|---------|-------|--------|
| 1 | preservation + progress    | 4   | Proven (modulo typing axioms) |
| 2 | projected_implies_coherent | 11  | Not started |
| 3 | deadlock_free              | 7   | Proven (requires ProgressReady gap) |
| 4 | MonStep_preserves_WTMon    | 6   | Proven |
| 5 | link_preserves_WTMon       | 7.7 | Not started |
| 6 | compose_deadlock_free      | 13  | Not started |

---

## Part 1: Effects/ Codebase

### Phase 1: Environments.lean

**Status**: Complete (0 axioms, 0 sorries)

### Phase 2: Coherence.lean

**Status**: 4/4 main theorems proven, 0 axioms, 0 sorries

**Main Theorems:**
- [x] `Coherent_empty`
- [x] `Coherent_send_preserved`
- [x] `Coherent_recv_preserved`
- [x] `initSession_coherent` (still uses placeholder projection assumption)

**Remaining Axioms (0):**
- *(none)*

**Proven since last update:**
- All 34 edge-case sorries eliminated (self-send/recv, protocol consistency, ValidLabels_recv/branch_preserved)
- `initSession_coherent` now proven (with placeholder projection assumption)
- `HasTypeProcPreOut_frame_left` proven (framing on the left)
- `HasTypeProcPreOut_frame_right` proven (framing on the right)
- `reachesComm_body_implies_unfold_aux` proven (no longer an axiom)
- `subst_preserves_muDepth` proven (induction on type structure)
- `deadlock_free` proven under `ProgressReady` (gap to be discharged by projection)

### Phase 3: Preservation.lean (helpers)

**Status**: Complete (0 axioms, 0 sorries; frame lemmas proven under disjointness)

### Phase 4: Preservation.lean (main theorems)

**Status**: Complete (TypedStep-based preservation/progress)

**Tasks:**
- [x] `preservation` (TypedStep wrapper)
- [x] `progress` (WellFormed wrapper)

### Phase 4B: Typing.lean

**Status**: Hybrid ownership+footprints+delta implemented; 0 sorries, 0 axioms remain.

**Critical Blockers:**
- [x] `preservation_typed` - par cases (split/merge) + owned SEnv threading
- [x] `progress_typed` - par split/merge for WellFormed (shared/owned)

**Remaining Axioms (0):**
- *(none)*

**Note:** Added coinductive `Compatible` (global compatibility/closure) to `WellFormed`.
`Compatible` provides `SendReady`/`SelectReady` for progress and is preserved by
construction via `GStep` closure. `preservation_typed` no longer requires
`NoNewSendStep`/`NoNewSelectStep`.

**Design decision (resolved):**
- [x] Extensional SEnv/DEnv (function-backed) chosen

**Reference:** `work/effects/008.lean` for inversions/progress patterns (adapt to shared/owned SEnv, footprints+delta, TypedStep)

### Phase 5: Semantics.lean - COMPLETE

### Phase 6: Monitor.lean - COMPLETE

**Status**: 0 axioms, 0 sorries

**Tasks:**
- [x] `MonStep_preserves_WTMon` - All sub-cases proven

### Phase 7: DeadlockFreedom.lean

**Status**: 0 axioms, 0 sorries (ProgressReady gap)

**Remaining Axioms (0):**
*(Gap)* `ProgressReady` assumption for `deadlock_free` (to be discharged by projection)

**Tasks:**
- [ ] Discharge `ProgressReady` from projection (Part 2)

### Phase 7.5: Spatial.lean - COMPLETE

### Phase 7.6: Determinism.lean - COMPLETE

### Phase 7.7: Deployment.lean

**Status**: 0 axioms, 0 sorries

**Tasks:**
- [ ] Port renaming lemmas from `work/effects/002.lean:390-441`:
  - [x] CoherentRenaming
  - [ ] BuffersTypedRenaming
  - [ ] HasTypeVal_rename
  - [ ] LinCtxValidRenaming equivalent

---

## Checkpoint 1 Criteria

Before Part 2 (RumpsteakV2 integration):
- [x] preservation theorem (Phase 4)
- [x] progress theorem (Phase 4)
- [x] MonStep_preserves_WTMon (Phase 6)
- [ ] deadlock_free theorem (Phase 7) — proven with ProgressReady gap
- [ ] link_preserves_WTMon (Phase 7.7)

---

## Part 2: RumpsteakV2 Integration

### Phase 8: Bridge Functions

- [ ] toEffectsLocalType
- [ ] fromEffectsLocalType
- [ ] roundtrip_to_from
- [ ] roundtrip_from_to

### Phase 9: GlobalType + Projection

- [ ] Copy GlobalType inductive
- [ ] Port wellFormed predicates
- [ ] Port trans projection
- [ ] trans_preserves_wellFormed

### Phase 10: Unify Representations

- [ ] Edge/Channel unification
- [ ] Add SessionId to RumpsteakV2
- [ ] Unified buffer abstraction

### Phase 11: Key Theorem

- [ ] projEnv definition
- [ ] initDEnv definition
- [ ] projected_implies_coherent

### Phase 12: Full Linking Judgment

- [ ] LinkEdge structure
- [ ] LinkOK judgment
- [ ] link_preserves_typing
- [ ] untrusted_cannot_forge_token
- [ ] untrusted_cannot_duplicate_token
- [ ] untrusted_bounded_by_token

---

## Checkpoint 2 Criteria

Before Part 3 (Composition guarantees):
- [ ] Bridge functions complete with roundtrip proofs
- [ ] projected_implies_coherent proven
- [ ] LinkOK judgment defined and decidable
- [ ] link_preserves_typing proven
- [ ] Untrusted actor theorems proven

---

## Part 3: Composition Guarantees

### Phase 13: Composition Preserves Deadlock Freedom

- [ ] compose_deadlock_free
- [ ] compose_progress
- [ ] composed_not_stuck

### Phase 14: End-to-End Deployment

- [ ] deploy function
- [ ] deploy_wellTyped
- [ ] deploy_deadlockFree
- [ ] safeCompose
- [ ] safeCompose_preserves_all
- [ ] verifyAndCompose

---

## Documentation Protocol

After completing any major phase of work:

1. **Update Proof Status:** Revise sorry counts and completion status
2. **Add New Theorems:** Document location, statement, purpose, proof strategy
3. **Update Cross-References:** Add theorems to topic-based index and dependency chains
4. **Update Dependency Diagrams:** Revise ASCII diagrams if structure changed
5. **Update File Sizes:** Run `wc -l` on modified files and update size reference
6. **Commit Together:** Include CODE_MAP.md updates in same commit as proof work

**Trigger Points:**
- Completing any phase (Phase 1-14)
- Reaching checkpoints (Checkpoint 1, 2, final)
- Eliminating significant sorries (>10 at once)
- Adding new files to Effects/
- Major refactoring of type system or semantics
- Monthly maintenance review

---

## Reference Files

| Directory/File | Purpose |
|----------------|---------|
| `lean/Effects/CODE_MAP.md` | Comprehensive Effects library map - all key theorems and proofs |
| `work/effects/001.lean` | Problem description, Consume formulations |
| `work/effects/002.lean` | Proven renaming/linking infrastructure |
| `work/effects/003.lean` | Semantic corrections, ConsumeFixed |
| `work/effects/004.lean` | Proven coherence preservation |
| `work/effects/007.lean` | Environment erasure proofs |
| `work/effects/008.lean` | Inversions/progress patterns |
| `work/linear_resource_spec.md` | Phase 4B design specification |
| `work/iris_lean_references.md` | Iris-lean components analysis |
