# Work Plan: Effects/ + Proof-Carrying Runtime + Composable Deployment

**Documentation:** Maintain `lean/Effects/CODE_MAP.md` throughout this work (see Documentation Protocol)

---

## Overview

**Goal**: Type-safe protocol composition with formal guarantees:
- Composition is type-safe
- Untrusted actors cannot violate protocol invariants
- Composition provably maintains deadlock freedom

**Structure**:
- Part 1 (Phases 1-7): Effects/ codebase (self-contained)
- Part 2 (Phases 8-12): RumpsteakV2 integration
- Part 3 (Phases 13-14): Composition guarantees

---

## Summary

| Phase | File | Sorries | Status |
|-------|------|---------|--------|
| 1 | Environments.lean    | 0  | Complete |
| 2 | Coherence.lean       | 36 | 3/4 main theorems proven |
| 3 | Preservation.lean    | 0  | Complete (helpers) |
| 4 | Preservation.lean    | 6  | Blocked on Phase 4B |
| 4B | Typing.lean         | 2  | 2 sorries remain (`preservation_typed`, `progress_typed` par case) |
| 5 | Semantics.lean       | 0  | Complete |
| 6 | Monitor.lean         | 11 | Partial |
| 7 | DeadlockFreedom.lean | 4  | Infrastructure complete |
| 7.5 | Spatial.lean       | 0  | Complete |
| 7.6 | Determinism.lean   | 0  | Complete |
| 7.7 | Deployment.lean    | 16 | In progress |
| - | Simulation.lean      | 0  | Complete |

**Total: 75 sorries across Effects/**

**Current status:** DEnv/SEnv migrated to permutation-invariant RBMap. Core typing/preservation builds; `lake build Effects.Typing` succeeds. Coherence has edge-case sorries but main theorems proven. Next: finish par split/merge in `Typing.lean` (blocks Phase 4 preservation/progress), then Coherence edge cases.

---

## Part 1: Effects/ Codebase

### Phase 1: Environments.lean - COMPLETE

### Phase 2: Coherence.lean

**Status**: 3/4 main theorems proven, 36 sorries (edge cases)

**Main Theorems:**
- [x] `Coherent_empty`
- [x] `Coherent_send_preserved`
- [x] `Coherent_recv_preserved`
- [ ] `initSession_coherent` (requires projection coherence from RumpsteakV2)

**Remaining Sorries (36):**
- Edge cases (35): self-sends, protocol consistency in recv/select/branch
- Helper (1): `Coherent_empty` helper case

**Tasks:**
- [ ] Port coherence helpers from `work/effects/004.lean:105-225`
- [ ] Complete edge case proofs for self-send/recv/branch
- [ ] Complete protocol consistency checks

### Phase 3: Preservation.lean (helpers) - COMPLETE

### Phase 4: Preservation.lean (main theorems)

**Status**: Blocked on Phase 4B (6 sorries)

**Tasks:**
- [ ] `preservation_send` (depends on Phase 4B)
- [ ] `preservation_recv` (depends on Phase 4B)
- [ ] `progress` (depends on above)

### Phase 4B: Typing.lean

**Status**: Hybrid ownership+footprints+delta implemented; 2 sorries remain

**Critical Blockers:**
- [ ] `preservation_typed` - par cases (split/merge) + owned SEnv threading
- [ ] `progress_typed` - par split/merge for WellFormed (shared/owned)

**Design Issues:**
1. **WellFormed splitting/merging** (blocks par cases):
   - Need: `StoreTyped (G₁++G₂) (S₁++S₂) → StoreTyped G₁ S₁` (with disjointness)
   - Need: `BuffersTyped (G₁++G₂) (D₁++D₂) → BuffersTyped G₁ D₁` (with disjointness)
   - Need: `Coherent (G₁++G₂) (D₁++D₂) → Coherent G₁ D₁` (with disjointness)
   - Need corresponding merge lemmas for outputs

2. **Framing axioms** (must be discharged):
   - [ ] Replace `HasTypeProcPre_frame_G` axiom
   - [ ] Replace `HasTypeProcPre_frame_left` axiom
   - [ ] Replace `HasTypeProcPreOut_frame_left` axiom
   - [ ] Replace `HasTypeProcPreOut_frame_right` axiom
   - [ ] Replace `Step_frame_append_right` axiom
   - [ ] Replace `Step_frame_append_left` axiom
   - [ ] Replace `SessionsOf_subset_of_HasTypeProcPreOut` axiom
   - [ ] Replace SEnv map axioms (lookup/append/subset/disjoint/assoc)

3. **Design decision (resolved):**
   - [x] Permutation-invariant SEnv (RBMap) chosen

**Reference:** `work/effects/008.lean` for inversions/progress patterns (adapt to shared/owned SEnv, footprints+delta, TypedStep)

### Phase 5: Semantics.lean - COMPLETE

### Phase 6: Monitor.lean

**Status**: 11 sorries

**Tasks:**
- [ ] `MonStep_preserves_WTMon` - Receiver readiness (4), initMonitorState (1), newSession invariants (3), supply freshness (3)

### Phase 7: DeadlockFreedom.lean

**Status**: 4 sorries

**Tasks:**
- [ ] `deadlock_free` (depends on `progress` from Phase 4B)
- [ ] `not_stuck` (depends on `deadlock_free`)
- [ ] `fair_recv_progress` (edge case)

### Phase 7.5: Spatial.lean - COMPLETE

### Phase 7.6: Determinism.lean - COMPLETE

### Phase 7.7: Deployment.lean

**Status**: 16 sorries

**Tasks:**
- [ ] Initial state invariants (6): initMonitorState preconditions
- [ ] Session selection (2): Session disjointness proofs
- [ ] Merge preservation (8): link_preserves_WTMon proof
- [ ] Port renaming lemmas from `work/effects/002.lean:390-441`:
  - [x] CoherentRenaming
  - [ ] BuffersTypedRenaming
  - [ ] HasTypeVal_rename
  - [ ] LinCtxValidRenaming equivalent

---

## Checkpoint 1 Criteria

Before Part 2 (RumpsteakV2 integration):
- [ ] preservation theorem (Phase 4)
- [ ] progress theorem (Phase 4)
- [ ] MonStep_preserves_WTMon (Phase 6)
- [ ] deadlock_free theorem (Phase 7)
- [ ] link_preserves_WTMon (Phase 7.7)

---

## Part 2: RumpsteakV2 Integration

### Phase 8: Bridge Functions

- [ ] toEffectsLocalType
- [ ] fromEffectsLocalType
- [ ] roundtrip_to_from
- [ ] roundtrip_from_to

### Phase 9: GlobalType + Projection

- [ ] Copy GlobalType inductive
- [ ] Port wellFormed predicates
- [ ] Port trans projection
- [ ] trans_preserves_wellFormed

### Phase 10: Unify Representations

- [ ] Edge/Channel unification
- [ ] Add SessionId to RumpsteakV2
- [ ] Unified buffer abstraction

### Phase 11: Key Theorem

- [ ] projEnv definition
- [ ] initDEnv definition
- [ ] projected_implies_coherent

### Phase 12: Full Linking Judgment

- [ ] LinkEdge structure
- [ ] LinkOK judgment
- [ ] link_preserves_typing
- [ ] untrusted_cannot_forge_token
- [ ] untrusted_cannot_duplicate_token
- [ ] untrusted_bounded_by_token

---

## Checkpoint 2 Criteria

Before Part 3 (Composition guarantees):
- [ ] Bridge functions complete with roundtrip proofs
- [ ] projected_implies_coherent proven
- [ ] LinkOK judgment defined and decidable
- [ ] link_preserves_typing proven
- [ ] Untrusted actor theorems proven

---

## Part 3: Composition Guarantees

### Phase 13: Composition Preserves Deadlock Freedom

- [ ] compose_deadlock_free
- [ ] compose_progress
- [ ] composed_not_stuck

### Phase 14: End-to-End Deployment

- [ ] deploy function
- [ ] deploy_wellTyped
- [ ] deploy_deadlockFree
- [ ] safeCompose
- [ ] safeCompose_preserves_all
- [ ] verifyAndCompose

---

## Key Theorems Summary

| # | Theorem | Phase | Status |
|---|---------|-------|--------|
| 1 | preservation + progress    | 4   | Blocked on 4B (2 sorries) |
| 2 | projected_implies_coherent | 11  | Not started |
| 3 | deadlock_free              | 7   | Depends on progress |
| 4 | link_preserves_WTMon       | 7.7 | In progress (16 sorries) |
| 5 | compose_deadlock_free      | 13  | Not started |

---

## Documentation Protocol

After completing any major phase of work:

1. **Update Proof Status:** Revise sorry counts and completion status
2. **Add New Theorems:** Document location, statement, purpose, proof strategy
3. **Update Cross-References:** Add theorems to topic-based index and dependency chains
4. **Update Dependency Diagrams:** Revise ASCII diagrams if structure changed
5. **Update File Sizes:** Run `wc -l` on modified files and update size reference
6. **Commit Together:** Include CODE_MAP.md updates in same commit as proof work

**Trigger Points:**
- Completing any phase (Phase 1-14)
- Reaching checkpoints (Checkpoint 1, 2, final)
- Eliminating significant sorries (>10 at once)
- Adding new files to Effects/
- Major refactoring of type system or semantics
- Monthly maintenance review

---

## Reference Files

| Directory/File | Purpose |
|----------------|---------|
| `lean/Effects/CODE_MAP.md` | Comprehensive Effects library map - all key theorems and proofs |
| `work/effects/001.lean` | Problem description, Consume formulations |
| `work/effects/002.lean` | Proven renaming/linking infrastructure |
| `work/effects/003.lean` | Semantic corrections, ConsumeFixed |
| `work/effects/004.lean` | Proven coherence preservation |
| `work/effects/007.lean` | Environment erasure proofs |
| `work/effects/008.lean` | Inversions/progress patterns |
| `work/linear_resource_spec.md` | Phase 4B design specification |
| `work/iris_lean_references.md` | Iris-lean components analysis |
