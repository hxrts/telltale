# Work Plan: Effects/ + Proof-Carrying Runtime + Composable Deployment

## Overview

**Goal**: Type-safe protocol composition with formal guarantees:
- Composition is type-safe
- Untrusted actors cannot violate protocol invariants
- Composition provably maintains deadlock freedom

**Structure**:
- Part 1 (Phases 1-7): Effects/ codebase (self-contained)
- Part 2 (Phases 8-12): RumpsteakV2 integration
- Part 3 (Phases 13-14): Composition guarantees

---

## Current State

### Summary

| Phase | File | Sorries | Status |
|-------|------|---------|--------|
| 1 | Environments.lean | 0 | Complete |
| 2 | Coherence.lean | 46 | 3/4 main theorems proven |
| 3 | Preservation.lean | 0 | Complete (helpers) |
| 4 | Preservation.lean | 3 | Blocked on Phase 4B |
| 4B | Typing.lean | 14 | Blocked on design issues |
| 5 | Semantics.lean | 0 | Complete |
| 6 | Monitor.lean | 11 | Partial |
| 7 | DeadlockFreedom.lean | 3 | Infrastructure complete |
| 7.5 | Spatial.lean | 0 | Complete |
| 7.6 | Determinism.lean | 0 | Complete |
| 7.7 | Deployment.lean | 17 | In progress |
| - | Simulation.lean | 1 | Minor |

**Total: 95 sorries across Effects/**

---

## Part 1: Effects/ Codebase

### Phase 1: Foundation Proofs (Environments.lean) - COMPLETE

[x] All 8 lookup/update lemmas proven (0 sorries): lookupStr_update_eq/neq, lookupG_update_eq/neq, lookupBuf_update_eq/neq, lookupD_update_eq/neq

---

### Phase 2: Coherence Proofs (Coherence.lean)

**Status**: 3/4 main theorems proven, 46 sorries (edge cases + renaming infrastructure)

#### Main Theorems

| Theorem | Status |
|---------|--------|
| `Coherent_empty` | [x] Proven |
| `Coherent_send_preserved` | [x] Proven |
| `Coherent_recv_preserved` | [x] Proven |
| `initSession_coherent` | [ ] Sorry (requires projection coherence from RumpsteakV2) |

#### Remaining Sorries (46)

| Category | Count | Description |
|----------|-------|-------------|
| Edge cases | 39 | Self-sends, protocol consistency in recv/select/branch |
| Renaming | 5 | CoherentRenaming, HasTypeVal_rename, BuffersTypedRenaming |
| Helper | 2 | Coherent_empty helper cases |

---

### Phase 3: Helper Lemmas (Preservation.lean) - COMPLETE

[x] Both helper lemmas proven (0 sorries): StoreTyped_update_nonChan, BuffersTyped_enqueue

---

### Phase 4: Main Theorems (Preservation.lean)

**Status**: Blocked on Phase 4B (3 sorries)

| Theorem | Status | Blocker |
|---------|--------|---------|
| `preservation_send` | [ ] Sorry | Phase 4B design |
| `preservation_recv` | [ ] Sorry | Phase 4B design |
| `progress` | [ ] Sorry | Depends on above |

---

### Phase 4B: Linear Resource Transition Typing (Typing.lean)

**Status**: Blocked on design issues (14 sorries)

#### Completed

- [x] TypedStep inductive (10 constructors)
- [x] Resource disjointness predicates (DisjointG, DisjointD, DisjointS)
- [x] WellFormed predicate
- [x] Support lemmas: HasTypeVal_weaken, HasTypeVal_updateG_weaken, StoreTyped_send_preserved, StoreTyped_assign_preserved
- [x] BuffersTyped_updateG_weaken: Buffer typing preserved under G updates
- [x] StoreTyped_recv_preserved: Store typing preserved when receiving values
- [x] Skip elimination proofs: seq_skip, par_skip_left, par_skip_right (3/3 complete)
- [x] preservation_typed send/recv cases: Full structure using BuffersTyped lemmas

#### Remaining Tasks

| Task | File | Sorries | Description |
|------|------|---------|-------------|
| typed_step_preserves_coherence | Typing.lean | 2 | par_left/par_right need append/disjoint lemmas |
| preservation_typed | Typing.lean | 5 | seq_step (monotonicity) + par cases (split/merge) |
| progress_typed | Typing.lean | 7 | send, recv, select, branch, seq, par, assign construction |

#### Critical Blockers (Fundamental Design Issues)

1. **HasTypeProcPre lacks monotonicity** (blocks seq_step):
   - In `seq P Q`, when P steps from (G,D,S) to (G',D',S'), Q needs to be retyped
   - No weakening lemma exists: `HasTypeProcPre S G Q → HasTypeProcPre S' G' Q`
   - May require redesigning TypedStep.seq_step or proving complex monotonicity property
   - **This is the primary blocker for preservation_typed completion**

2. **WellFormed splitting/merging** (blocks par cases):
   - Need: `StoreTyped (G₁++G₂) (S₁++S₂) → StoreTyped G₁ S₁` (with disjointness)
   - Need: `BuffersTyped (G₁++G₂) (D₁++D₂) → BuffersTyped G₁ D₁` (with disjointness)
   - Need: `Coherent (G₁++G₂) (D₁++D₂) → Coherent G₁ D₁` (with disjointness)
   - Need corresponding merge lemmas for outputs

3. **BuffersTyped lemmas** (module organization):
   - BuffersTyped_enqueue: Proven in Preservation.lean, sorried in Typing.lean (circular dependency)
   - BuffersTyped_dequeue: Needs full proof, currently sorried

#### Recent Progress (2026-01-15)

- Commits: `1bf58ad`, `ae38b17`, `abf13de`
- Reduced sorries from ~25 to 14
- Identified HasTypeProcPre monotonicity as fundamental blocker
- Documented all remaining proof obligations and blockers

---

### Phase 5: Determinism (Semantics.lean) - COMPLETE

[x] stepBase_deterministic proven (0 sorries). Deterministic modulo par (where both par_skip_left and par_skip_right can apply).

---

### Phase 6: Proof-Carrying Runtime (Monitor.lean)

**Status**: Partial (11 sorries)

#### Completed

- [x] MonitorState structure
- [x] ProtoAction inductive
- [x] MonStep judgment (send/recv/select/branch)
- [x] WTMon predicate

#### Remaining Tasks

| Theorem | Sorries | Description |
|---------|---------|-------------|
| MonStep_preserves_WTMon | 11 | Receiver readiness (4), initMonitorState (1), newSession invariants (3), supply freshness (3) |

---

### Phase 7: Deadlock Freedom (DeadlockFreedom.lean)

**Status**: Infrastructure complete (3 sorries in main theorems)

#### Completed

- [x] Guarded predicate and guardedDecide checker
- [x] ReachesComm predicate and reachesCommDecide checker
- [x] Done, CanProgress, Stuck, FairTrace predicates
- [x] session_isolation theorem
- [x] disjoint_sessions_commute theorem

#### Remaining Tasks

| Theorem | Status | Dependencies |
|---------|--------|--------------|
| deadlock_free | [ ] Sorry | progress theorem from Phase 4B |
| not_stuck | [ ] Uses deadlock_free | deadlock_free |
| fair_recv_progress | [ ] Sorry | Edge case |

---

### Phase 7.5: Spatial Typing (Spatial.lean) - COMPLETE

[x] All spatial typing infrastructure ported (0 sorries): SpatialReq inductive, SiteCapabilities, Topology, Satisfies judgment, satisfiesBool checker, SpatialLe preorder, spatial_le_sound monotonicity, spatial_le_contrapositive, requirement builders (commReq, timedChoiceReq, branchesReq), topology builders (allColocated, fullyConnected), colocated_implies_edge, Effects integration (endpointReq, edgeReq, supportsGEnv)

---

### Phase 7.6: Determinism Proofs (Determinism.lean) - COMPLETE

[x] All determinism infrastructure ported (0 sorries): uniqueBranchLabelsList, mem_branch_unique_label, IndependentSessions, IndependentConfigs, diamond_independent_sessions, localType_step_det, DeterminismClaims bundle

---

### Phase 7.7: Deployment Infrastructure (Deployment.lean)

**Status**: In progress (17 sorries)

#### Completed

- [x] DeployedProtocol structure
- [x] InterfaceType structure
- [x] SessionRenaming with rename operations
- [x] Lookup lemmas for renamed environments

#### Remaining Tasks

| Category | Sorries | Description |
|----------|---------|-------------|
| Initial state invariants | 6 | initMonitorState preconditions |
| Session selection | 2 | Session disjointness proofs |
| Merge preservation | 9 | link_preserves_WTMon proof |

#### Blocking Work (Phase 7.7.1-7.7.6)

| Task | Description | Dependencies |
|------|-------------|--------------|
| 7.7.2 | Port CoherentRenaming, BuffersTypedRenaming, LinCtxValidRenaming | Renaming infrastructure |
| 7.7.3 | Port SessionsOf, SessionDisjoint, RenamedDisjoint | Disjointness predicates |
| 7.7.4 | Port MergeGEnv/DEnv/Bufs lemmas | Merge operations |
| 7.7.5 | Prove Dual_implies_Consume_empty | Bridge initialization |
| 7.7.6 | Complete link_preserves_WTMon | All above |

---

## Checkpoint 1 Criteria

Before Part 2 (RumpsteakV2 integration):

- [ ] preservation theorem (Phase 4)
- [ ] progress theorem (Phase 4)
- [ ] MonStep_preserves_WTMon (Phase 6)
- [ ] deadlock_free theorem (Phase 7)
- [ ] link_preserves_WTMon (Phase 7.7)

---

## Part 2: RumpsteakV2 Integration

### Phase 8: Bridge Functions

| Task | Status |
|------|--------|
| toEffectsLocalType | [ ] Not started |
| fromEffectsLocalType | [ ] Not started |
| roundtrip_to_from | [ ] Not started |
| roundtrip_from_to | [ ] Not started |

### Phase 9: GlobalType + Projection

| Task | Status |
|------|--------|
| Copy GlobalType inductive | [ ] Not started |
| Port wellFormed predicates | [ ] Not started |
| Port trans projection | [ ] Not started |
| trans_preserves_wellFormed | [ ] Not started |

### Phase 10: Unify Representations

| Task | Status |
|------|--------|
| Edge/Channel unification | [ ] Not started |
| Add SessionId to RumpsteakV2 | [ ] Not started |
| Unified buffer abstraction | [ ] Not started |

### Phase 11: Key Theorem

| Task | Status |
|------|--------|
| projEnv definition | [ ] Not started |
| initDEnv definition | [ ] Not started |
| projected_implies_coherent | [ ] Not started |

### Phase 12: Full Linking Judgment

| Task | Status |
|------|--------|
| LinkEdge structure | [ ] Not started |
| LinkOK judgment | [ ] Not started |
| link_preserves_typing | [ ] Not started |
| untrusted_cannot_forge_token | [ ] Not started |
| untrusted_cannot_duplicate_token | [ ] Not started |
| untrusted_bounded_by_token | [ ] Not started |

---

## Checkpoint 2 Criteria

Before Part 3 (Composition guarantees):

- [ ] Bridge functions complete with roundtrip proofs
- [ ] projected_implies_coherent proven
- [ ] LinkOK judgment defined and decidable
- [ ] link_preserves_typing proven
- [ ] Untrusted actor theorems proven

---

## Part 3: Composition Guarantees

### Phase 13: Composition Preserves Deadlock Freedom

| Task | Status |
|------|--------|
| compose_deadlock_free | [ ] Not started |
| compose_progress | [ ] Not started |
| composed_not_stuck | [ ] Not started |

### Phase 14: End-to-End Deployment

| Task | Status |
|------|--------|
| deploy function | [ ] Not started |
| deploy_wellTyped | [ ] Not started |
| deploy_deadlockFree | [ ] Not started |
| safeCompose | [ ] Not started |
| safeCompose_preserves_all | [ ] Not started |
| verifyAndCompose | [ ] Not started |

---

## Key Theorems Summary

| # | Theorem | Phase | Status |
|---|---------|-------|--------|
| 1 | preservation + progress | 4 | [ ] Blocked on 4B |
| 2 | projected_implies_coherent | 11 | [ ] Not started |
| 3 | deadlock_free | 7 | [ ] Depends on progress |
| 4 | link_preserves_WTMon | 7.7 | [ ] In progress (17 sorries) |
| 5 | compose_deadlock_free | 13 | [ ] Not started |

---

## Reference Files

| Directory | Purpose |
|-----------|---------|
| `work/effects/001.lean` | Problem description, Consume formulations |
| `work/effects/002.lean` | Proven renaming/linking infrastructure |
| `work/effects/003.lean` | Semantic corrections, ConsumeFixed |
| `work/effects/004.lean` | Proven coherence preservation |
| `work/effects/007.lean` | Environment erasure proofs |
| `work/linear_resource_spec.md` | Phase 4B design specification |
