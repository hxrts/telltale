# V2 Work Plan: Remaining Proof Obligations

**Last Updated:** 2026-01-15

## Summary

| Codebase | Axioms | Sorries | Status |
|----------|--------|---------|--------|
| Inductive | 29 | 10 | Harmony coherence near complete |
| Coinductive | 7 | 12 | BisimDecidable in progress |

**Key Progress:**
- âœ… All 4 mu-unfold axioms eliminated (MuUnfoldLemmas.lean)
- âœ… `trans_subst_comm` proven via paco coinduction
- âœ… `proj_trans_other_step` mu case complete
- âœ… Environment erasure (EQ2CE â†’ EQ2C) complete
- âœ… `toInductiveAux_eq2c` all cases proven
- âœ… `transBranches_satisfies_BranchesProjRel` helper proven (no sorries)
- ðŸš§ `trans_produces_CProject` - structured but 6 sorries remain
- ðŸš§ `branches_project_coherent` - 10 sorries total (2 tactical, 8 substantive)
- ðŸš§ BisimDecidable - 8 sorries remaining

---

## Inductive Codebase

### Axiom Inventory (29 total)

| File | Count | Axioms |
|------|-------|--------|
| Project.lean | 19 | `EQ2_isGuarded_compat`, `CProject_isGuarded_trans`, 12 constructor incompatibility, 3 extraction, 2 composition |
| ProjSubst.lean | 3 | `proj_subst`, `isGuarded_substitute_preserved`, `isGuarded_substitute_unguarded` |
| Harmony.lean | 2 | `proj_trans_sender_step_axiom`, `proj_trans_receiver_step_axiom` |
| EQ2.lean | 2 | `ReflRel_postfix`, `TransRel_postfix` |
| Bisim.lean | 1 | `RelImage_of_Bisim_with_reflexivity` |
| DBBridge.lean | 1 | `EQ2_subst_mu_comm_via_DB` |
| EmbedProps.lean | 1 | `lcontractive_implies_isGuarded` |

### Sorry Inventory (10 total)

| File | Count | Location |
|------|-------|----------|
| Harmony.lean | 10 | Lines 160, 234, 238, 241, 250, 257, 261, 317, 320, 335 |
| Trans.lean | 0 | All documentation |

**Harmony.lean breakdown:**
- 2 tactical (lines 234, 238): .end/.var CProjectF match reduction (definitionally trivial)
- 8 substantive: mu case, BranchesProjRel construction, AllBranchesProj, applications

### Completed Work


âœ… Harmony Phase 2: trans_subst_comm (proven via paco coinduction)

- Defined `ProjSubstRel` witness relation
- Proved via `EQ2_paco_coind` with well-founded induction
- All cases complete: `.end`, `.var v`, `.mu s inner`, `.comm`



âœ… Harmony Phase 3: proj_trans_other_step mu case

- Implemented at Harmony.lean:846-871
- Uses `trans_substitute_unfold` + `EQ2_trans` + `EQ2_unfold_right`



âœ… Mu-Unfold Axioms (all 4 proven in MuUnfoldLemmas.lean)

- `EQ2_mu_crossed_unfold_left` - via `proj_subst` + `EQ2_mu_self_unfold`
- `EQ2_mu_crossed_unfold_right` - symmetric case
- `EQ2_mu_unguarded_to_end` - vacuously true (guardedness contradiction when s â‰  t)
- `EQ2_end_to_mu_unguarded` - vacuously true for closed types



âœ… SubstEndUnguarded.lean: subst_end_unguarded_eq2_end

- Proven via `UnfoldsToEnd` coinductive relation


âœ… transBranches_satisfies_BranchesProjRel (commit 028c3b7)

- **Status: PROVEN** (no sorries)
- Proven by induction on branch lists
- Shows that `transBranches` produces branches satisfying `BranchesProjRel` with the witness relation
- Used in sender/receiver cases of `trans_produces_CProject`


### In Progress

#### Harmony Phase 4: branches_project_coherent (10 sorries: 2 tactical, 8 substantive)

Following Coq's structural coherence approach via `AllBranchesProj`.

**Infrastructure:**
- ðŸš§ `trans_branches_coherent_EQ2` - structured but incomplete (1 sorry at line 160: part_of_all2 case)
- âœ… `transBranches_satisfies_BranchesProjRel` - helper lemma (PROVEN by induction, no sorries)
- ðŸš§ `trans_produces_CProject` - structured but incomplete (6 sorries remain):
  - ðŸš§ .end case: tactical issue at line 234 (definitionally trivial)
  - ðŸš§ .var case: tactical issue at line 238 (definitionally trivial)
  - ðŸš§ .mu case: needs guardedness reasoning (line 241)
  - ðŸš§ .comm sender: needs BranchesProjRel application (line 250)
  - ðŸš§ .comm receiver: needs BranchesProjRel application (line 257)
  - ðŸš§ .comm non-participant: needs AllBranchesProj (line 261)
- ðŸš§ Helper lemmas in GlobalType.lean (no sorries but depends on `wellFormed_comm_branches` axiom)

**Tactical sorries (definitionally trivial, need exact tactic sequence):**
| Line | Description |
|------|-------------|
| 234 | .end case: CProjectF match reduces to True |
| 238 | .var case: CProjectF match reduces to t = t |

**Substantive sorries (require proof work):**
| Line | Description |
|------|-------------|
| 160 | `part_of_all2` - uniform participation inference |
| 241 | .mu case: guardedness + recursive relation |
| 250 | .comm sender: BranchesProjRel via helper lemma |
| 257 | .comm receiver: BranchesProjRel via helper lemma |
| 261 | .comm non-participant: AllBranchesProj establishment |
| 317, 320 | `trans_produces_CProject` applications |
| 335 | AllBranchesProj + CProject_implies_EQ2_trans |

### Remaining Work

#### Harmony Phase 5: sender/receiver step
- [ ] `proj_trans_sender_step` - parallel to other_step structure
- [ ] `proj_trans_receiver_step` - dual to sender

#### Project.lean: Observable Preservation (19 axioms)
- [ ] 12 constructor incompatibility axioms via CProject/trans/EQ2 analysis
- [ ] 3 extraction axioms via coinductive reasoning
- [ ] 2 composition axioms via EQ2 closure properties

#### Other Axioms
- [ ] `EQ2_subst_mu_comm_via_DB` - de Bruijn bridge or Barendregt proof
- [ ] `lcontractive_implies_isGuarded` - structural analysis
- [ ] EQ2.lean witness axioms - coinductive proof patterns
- [ ] Bisim.lean RelImage axiom - bisimulation reasoning

---

## Coinductive Codebase

### Axiom Inventory (7 total, all in Roundtrip.lean)

All are intentional stubs with proofs in RoundtripWIP.lean:
- `nameOf`, `envOf` - name/environment generation
- `toCoind_toInductive_eq2ce` - round-trip in EQ2CE
- `toCoind_toInductive_eq2c_of_eq2ce/backedge/env` - EQ2C variants
- `toCoind_toInductive` - main round-trip theorem

### Sorry Inventory (12 total)

| File | Count | Description |
|------|-------|-------------|
| RoundtripWIP.lean | 3 | 1 termination (`decreasing_by`), 2 in comments |
| BisimDecidable.lean | 8 | Bounded mu-nesting, witness construction, soundness |
| Roundtrip.lean | 1 | Documentation |

### Completed Work

âœ… Core Coinductive Infrastructure

- LocalTypeC with constructors, injectivity/distinctness lemmas
- Observable, WellFormed predicates and preservation lemmas
- toCoind/toInductive bridge functions
- EQ2C/Bisim layer with mu-unfold lemmas
- Dual transport and involution proofs

âœ… Environment Erasure (EQ2CE â†’ EQ2C)

- `EQ2CE_resolved'_step_to_EQ2C` - one step conversion
- `EQ2CE_resolved'_implies_EQ2C` - full conversion (termination by guardedness)
- `EQ2CE_step_to_EQ2C_varR` - handles all cases including mu_left/mu_right

âœ… toInductiveAux_eq2c (all cases proven)

- Visited case: via `toInductiveAux_visited` + back-edge hypothesis
- End/Var: via characterization lemmas + `EQ2C_end/var_head`
- Mu: via `EQ2C_unfold_left` + recursive IH
- Send/Recv: via `EQ2C_send/recv_head` + `BranchesRelC_ofFn`

âœ… BisimDecidable Core Structure

- `BisimRel = BisimRelCore âˆ¨ EQ2C` defined
- `EQ2C_postfixpoint` proven
- `BisimRel_postfixpoint` all cases complete (visited/end/var/send/recv)
- 9 helper lemmas proven for label matching and children proofs

### In Progress

#### RoundtripWIP.lean (1 essential sorry)

```
Line 180: decreasing_by all_goals sorry
```

**Justification:** Termination is sound for regular types via coinductive guardedness. The paco coinduction pattern ensures progress.

**Alternative:** Use `BisimDecidable.EQ2CE_resolved'_implies_EQ2C_via_bisim` for regular types.

#### BisimDecidable.lean (8 sorries)

| Line | Description | Priority |
|------|-------------|----------|
| 97 | `hasNonMuHead_fullUnfoldN_of_regular` - bounded mu-nesting | Infrastructure |
| 485, 539 | Witness construction in send/recv cases | Medium |
| 811, 820 | Soundness theorem stubs | Medium |
| 862 | Termination via environment resolution | Low (has workaround) |

---

## Priority Ranking

### P0: Axiom Elimination (Subject Reduction Path)

1. **Harmony axioms** (2 remaining)
   - `proj_trans_sender_step_axiom` - Phase 5
   - `proj_trans_receiver_step_axiom` - Phase 5

2. **Project axioms** (19) - Observable preservation

### P1: Infrastructure

3. **ProjSubst axioms** (3) - Port from Coq indProj.v:173
4. **EQ2.lean axioms** (2) - Witness relations
5. **Bisim.lean axiom** (1) - RelImage
6. **DBBridge.lean axiom** (1) - Substitution commutation
7. **EmbedProps.lean axiom** (1) - Contractiveness â†’ guardedness

### P2: Coinductive

8. **Roundtrip.lean axioms** (7) - Stubs for RoundtripWIP proofs
9. **BisimDecidable sorries** (8) - Decidable bisimulation infrastructure

---

## Success Criteria

`lake build RumpsteakV2` completes with:
- Axiom count reduced from 29 to <15 (inductive)
- Coinductive axioms (7) remain stubbed until subject reduction complete
- All sorries documented with proof strategies

---

## Reference Files

| Directory | Purpose |
|-----------|---------|
| `work/coinductive/` | Prototype implementations and proof sketches |
| `work/effects/` | Semantic analysis (005-007.lean contain key patterns) |

**Key references:**
- `005.lean` - Counterexample for flawed toInductiveAux (RumpsteakV2 verified correct)
- `006.lean` - Back-edge hypothesis pattern (applied to toInductiveAux_eq2c)
- `007.lean` - Environment erasure via paco (adapted for EQ2CE_to_EQ2C)
